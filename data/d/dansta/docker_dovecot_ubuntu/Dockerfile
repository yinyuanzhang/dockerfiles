FROM ubuntu:latest
# dovecot imap/pop3-server

# set env. replace right most column with values specific to your environment
ARG DOVECOT_SINGLE_USER
ENV DOVECOT_SINGLE_USER ${DOVECOT_SINGLE_USER:-johndoe}
ARG DOVECOT_FQDN
ENV DOVECOT_FQDN ${DOVECOT_FQDN:-example.com}
ARG DOVECOT_BANLIST
ENV DOVECOT_BANLIST ${DOVECOT_BANLIST:-shared_banlist.txt}
ARG DOVECOT_PROTOCOLS
ENV DOVECOT_PROTOCOLS ${DOVECOT_PROTOCOLS:-imap pop3}
ARG DOVECOT_IP_ADDRESS
ENV DOVECOT_IP_ADDRESS ${DOVECOT_IP_ADDRESS:-127.0.0.1}
ARG DOVECOT_IMAP_PLAIN_PORT
ENV DOVECOT_IMAP_PLAIN_PORT ${DOVECOT_IMAP_PLAIN_PORT:-143}
ARG DOVECOT_IMAP_SSL_PORT
ENV DOVECOT_IMAP_SSL_PORT ${DOVECOT_IMAP_SSL_PORT:-993}
ARG DOVECOT_POP3_PLAIN_PORT
ENV DOVECOT_POP3_PLAIN_PORT ${DOVECOT_POP3_PLAIN_PORT:-110}
ARG DOVECOT_POP3_SSL_PORT
ENV DOVECOT_POP3_SSL_PORT ${DOVECOT_POP3_SSL_PORT:-995}
ARG DOVECOT_LOG_PATH
ENV DOVECOT_LOG_PATH ${DOVECOT_LOG_PATH:-/var/log/dovecot/}
ARG DOVECOT_CERT_FILE
ENV DOVECOT_CERT_FILE ${DOVECOT_CERT_FILE:-/dynamic/${DOVECOT_FQDN}_cert.pem}
ARG DOVECOT_KEY_FILE
ENV DOVECOT_KEY_FILE ${DOVECOT_KEY_FILE:-/dynamic/${DOVECOT_FQDN}_key.pem}
ARG DOVECOT_USER
ENV DOVECOT_USER ${DOVECOT_USER:-dovecot}
ARG DOVECOT_LISTENING_LOGIN_PROCESSES
ENV DOVECOT_LISTENING_LOGIN_PROCESSES ${DOVECOT_LISTENING_LOGIN_PROCESSES:-3}
ARG DOVECOT_MAX_PROCESSES_COUNT
ENV DOVECOT_MAX_PROCESSES_COUNT ${DOVECOT_MAX_PROCESSES_COUNT:-10}
ARG DOVECOT_LOGIN_MAX_CONNECTIONS
ENV DOVECOT_LOGIN_MAX_CONNECTIONS ${DOVECOT_LOGIN_MAX_CONNECTIONS:-10}
ARG DOVECOT_GREET_MESSAGE 
ENV DOVECOT_GREET_MESSAGE ${DOVECOT_GREET_MESSAGE:-"Hi!"}
ARG DOVECOT_TRUSTED_NETWORKS
ENV DOVECOT_TRUSTED_NETWORKS ${DOVECOT_TRUSTED_NETWORKS:-127.0.0.0/24}
ARG DOVECOT_MAIL_LOCATION
ENV DOVECOT_MAIL_LOCATION ${DOVECOT_MAIL_LOCATION:-maildir:~/Maildir}
ARG DOVECOT_MAIL_UID
ENV DOVECOT_MAIL_UID ${DOVECOT_MAIL_UID:-500}
ARG DOVECOT_MAIL_GID
ENV DOVECOT_MAIL_GID ${DOVECOT_MAIL_GID:-500}
ARG DOVECOT_MAIL_PRIVILEGED_GROUP
ENV DOVECOT_MAIL_PRIVILEGED_GROUP ${DOVECOT_MAIL_PRIVILEGED_GROUP:-root}
ARG DOVECOT_MAIL_DEBUG
ENV DOVECOT_MAIL_DEBUG ${DOVECOT_MAIL_DEBUG:-true}
ARG DOVECOT_MAX_MAIL_PROCESSES
ENV DOVECOT_MAX_MAIL_PROCESSES ${DOVECOT_MAX_MAIL_PROCESSES:-10}
ARG DOVECOT_MAX_PROCESS_SIZE
ENV DOVECOT_MAX_PROCESS_SIZE ${DOVECOT_MAX_PROCESSES_SIZE:-10}
ARG DOVECOT_CACHE_MIN_MAIL_COUNT
ENV DOVECOT_CACHE_MIN_MAIL_COUNT ${DOVECOT_CACHE_MIN_MAIL_COUNT:-10}
ARG DOVECOT_IDLE_CHECK_INTERVAL
ENV DOVECOT_IDLE_CHECK_INTERVAL ${DOVECOT_IDLE_CHECK_INTERVAL:-3}
ARG DOVECOT_MAX_USERIP_CONNECTIONS
ENV DOVECOT_MAX_USERIP_CONNECTIONS ${DOVECOT_MAX_USERIP_CONNECTIONS:-10}
ARG DOVECOT_IMAP_IDLE_NOTIFY_INTERVAL
ENV DOVECOT_IMAP_IDLE_NOTIFY_INTERVAL ${DOVECOT_IMAP_IDLE_NOTIFY_INTERVAL:-3}
ARG DOVECOT_POP3_MAX_USERIP_CONNECTIONS
ENV DOVECOT_POP3_MAX_USERIP_CONNECTIONS ${DOVECOT_POP3_MAX_USERIP_CONNECTIONS:-10}
ARG DOVECOT_AUTH_PROCESS_SIZE
ENV DOVECOT_AUTH_PROCESS_SIZE ${DOVECOT_AUTH_PROCESS_SIZE:-20}
ARG DOVECOT_AUTH_WORKER_MAX_COUNT
ENV DOVECOT_AUTH_WORKER_MAX_COUNT ${DOVECOT_AUTH_WORKER_MAX_COUNT:-10}
ARG DOVECOT_DENY_LOGIN_FILE 
ENV DOVECOT_DENY_LOGIN_FILE ${DOVECOT_DENY_LOGIN_FILE:-/dynamic/${DOVECOT_BANLIST}}
ARG DOVECOT_DICT_DB_CONFIG 
ENV DOVECOT_DICT_DB_CONFIG ${DOVECOT_DICT_DB_CONFIG:-/usr/share/example/bk/dict.conf}

LABEL maintainer=dansta

# add proxies, in case you are rebuilding on a system behind a proxy
#ADD files/apt.conf /etc/apt/apt.conf

# update and install packages
RUN apt-get update
RUN apt-get install -y dovecot-imapd \
                       dovecot-pop3d \
                       python3
ADD files/etc/dovecot.conf /etc/dovecot/dovecot.conf
ADD files/replace.py /usr/local/bin/replace_conf
RUN chmod +rx /usr/local/bin/replace_conf
RUN /usr/local/bin/replace_conf /etc/dovecot/dovecot.conf DOVECOT

# remove python3 again because it is not needed for runtime
RUN apt-get remove -y python3 && \
    apt-get -y autoremove 


# document port usage for docker in case you are going to use it as a service
EXPOSE ${DOVECOT_IMAP_PLAIN_PORT}/tcp \
       ${DOVECOT_IMAP_SSL_PORT}/tcp \
       ${DOVECOT_POP3_PLAIN_PORT}/tcp \
       ${DOVECOT_POP3_SSL_PORT}/tcp


VOLUME /usr/share/example/bk/ \
       /var/log/dovecot/ \
       /home/ \
       /dynamic/

# Healthcheck, tests login every 15 seconds with dummy user
HEALTHCHECK --interval=15s --timeout=3s CMD doveadm auth test \
                                            -x service=imap \
                                            -x rip=localhost \
                                            -x lport=${DOVECOT_IMAP_PLAIN_PORT} \
                                            ${DOVECOT_SINGLE_USER}

# test dovecot for build, run in foreground
CMD /usr/sbin/dovecot
