ARG APP_DIR="/app"
ARG SLIDESHOW_SERVER_WEB_DIR="www"
ARG SLIDESHOW_ADMIN_BUILD_DIR="www"
ARG SLIDESHOW_SERVER_BINARY="slideshow-server"


FROM golang:1.12.5 as ServerBuilder
ARG APP_DIR
ARG SLIDESHOW_SERVER_BINARY
ARG TMP_DIR="/tmp"
ARG SLIDESHOW_SERVER_VERSION="v0.1.1"
ARG SLIDESHOW_SERVER_REGISTRY="Oppodelldog"
ARG SLIDESHOW_SERVER_REPOSITORY="slideshow-server"

WORKDIR ${TMP_DIR}

RUN git clone https://github.com/${SLIDESHOW_SERVER_REGISTRY}/${SLIDESHOW_SERVER_REPOSITORY}

WORKDIR ${TMP_DIR}/${SLIDESHOW_SERVER_REPOSITORY}
 
RUN git checkout ${SLIDESHOW_SERVER_VERSION} && \
    make build
    
RUN mkdir -p ${APP_DIR} && \
    cp .build/${SLIDESHOW_SERVER_BINARY} ${APP_DIR}/${SLIDESHOW_SERVER_BINARY} && \
    chmod u+x ${APP_DIR}/${SLIDESHOW_SERVER_BINARY} && \
    cp slideshows.json ${APP_DIR}/slideshows.json



FROM node:8.9.0 as AdminBuilder  
ARG APP_DIR
ARG SLIDESHOW_ADMIN_BUILD_DIR
ARG TMP_DIR="/tmp"
ARG SLIDESHOW_ADMIN_VERSION="v0.1.0"
ARG SLIDESHOW_ADMIN_APP_INDEX_PAGE="index.html"
ARG SLIDESHOW_ADMIN_APP_REGISTRY="Oppodelldog"
ARG SLIDESHOW_ADMIN_APP_REPOSITORY="slideshow-admin"

WORKDIR ${TMP_DIR}

RUN git clone https://github.com/${SLIDESHOW_ADMIN_APP_REGISTRY}/${SLIDESHOW_ADMIN_APP_REPOSITORY}

WORKDIR ${TMP_DIR}/${SLIDESHOW_ADMIN_APP_REPOSITORY}
 
RUN git checkout ${SLIDESHOW_ADMIN_VERSION} && \
    ./build.sh
    
RUN mkdir -p ${APP_DIR} && \
    cp -rp ${SLIDESHOW_ADMIN_BUILD_DIR} ${APP_DIR}/${SLIDESHOW_ADMIN_BUILD_DIR}

   
   
FROM ubuntu:latest
ARG APP_DIR
ARG SLIDESHOW_ADMIN_BUILD_DIR
ARG SLIDESHOW_SERVER_WEB_DIR
ARG SLIDESHOW_SERVER_BINARY
ARG SLIDESHOW_ADMIN_APP_TARGET_DIR="admin"

WORKDIR ${APP_DIR}

RUN echo "#!/bin/bash \n exec ${APP_DIR}/${SLIDESHOW_SERVER_BINARY}" > /${APP_DIR}/entrypoint.sh && \
    chmod u+x  ${APP_DIR}/entrypoint.sh && \ 
    mkdir -p ${APP_DIR}/${SLIDESHOW_ADMIN_APP_TARGET_DIR}
    
COPY --from=ServerBuilder ${APP_DIR} ${APP_DIR}
COPY --from=AdminBuilder ${APP_DIR}/${SLIDESHOW_ADMIN_BUILD_DIR} ${APP_DIR}/${SLIDESHOW_SERVER_WEB_DIR}/${SLIDESHOW_ADMIN_APP_TARGET_DIR}

CMD ["/app/entrypoint.sh"]
