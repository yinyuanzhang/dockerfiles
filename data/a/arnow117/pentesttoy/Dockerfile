FROM arnow117/ubuntu_base:latest

MAINTAINER arnow117 "arnow117@gmail.com"

# fork and modify from remux
ENV TOOLS_PATH /root/Tools
ENV WORK_PATH /root/Workspace
WORKDIR $TOOLS_PATH

RUN apt-get update && apt-get -y install \
  git build-essential zlib1g zlib1g-dev \
  libxml2 libxml2-dev libxslt-dev locate curl \
  libreadline6-dev libcurl4-openssl-dev git-core \
  libssl-dev libyaml-dev openssl autoconf libtool \
  ncurses-dev bison xsel postgresql \
  postgresql-contrib postgresql-client libpq-dev \
  libapr1 libaprutil1 libsvn1 \
  libpcap-dev libsqlite3-dev libgmp3-dev \
  nasm nmap \
  && rm -rf /var/lib/apt/lists/*

# Get Metasploit
RUN git clone https://github.com/rapid7/metasploit-framework.git $TOOLS_PATH/msf
WORKDIR $TOOLS_PATH/msf

# Install PosgreSQL
COPY scripts/db.sql /tmp/db.sql
RUN /etc/init.d/postgresql start && su postgres -c "psql -f /tmp/db.sql"
RUN su root
COPY conf/database.yml $TOOLS_PATH/msf/config/database.yml

# RVM
RUN gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
RUN \curl -sSL https://get.rvm.io | bash -s stable

# # Cache for China timeout...
# RUN echo "ruby_url=https://cache.ruby-china.org/pub/ruby" > /usr/local/rvm/user/db

RUN /bin/bash -l -c "source /usr/local/rvm/scripts/rvm"
RUN /bin/bash -l -c "rvm requirements"
RUN /bin/bash -l -c "rvm install $(cat .ruby-version)"

# # Cache for China timeout...
# RUN /bin/bash -l -c "gem sources --add https://gems.ruby-china.org/ --remove https://rubygems.org/"

# gem install bundler
RUN /bin/bash -l -c "gem install bundler --no-ri --no-rdoc"
RUN /bin/bash -l -c "source /usr/local/rvm/scripts/rvm && which bundle"
RUN /bin/bash -l -c "which bundle"

# # Cache for China timeout...
# RUN /bin/bash -l -c "bundle config mirror.https://rubygems.org https://gems.ruby-china.org"

# Get MSF dependencies
RUN /bin/bash -l -c "BUNDLEJOBS=$(expr $(cat /proc/cpuinfo | grep vendor_id | wc -l) - 1)"
RUN /bin/bash -l -c "bundle config --global jobs $BUNDLEJOBS"
RUN /bin/bash -l -c "bundle install"

# Symlink MSF tools to $PATH
RUN for i in `ls $TOOLS_PATH/msf/tools/*/*`; do ln -s $i /usr/local/bin/; done
RUN ln -s $TOOLS_PATH/msf/msf* /usr/local/bin

# settings and custom scripts folder
# VOLUME /root/.msf4/
# VOLUME $WORK_PATH

# Starting script (DB + updates)
COPY scripts/init.sh /usr/local/bin/init.sh
COPY util/ruby_proxy.sh $TOOLS_PATH/ruby_proxy.sh
RUN chmod a+xr /usr/local/bin/init.sh $TOOLS_PATH/ruby_proxy.sh
RUN echo source /etc/profile.d/rvm.sh >> ~/.zshrc

CMD /usr/local/bin/init.sh
# WORKDIR $WORK_PATH
