FROM ansibleplaybookbundle/apb-base

LABEL "com.redhat.apb.spec"=\
"dmVyc2lvbjogMS4wCm5hbWU6IGltcG9ydC12bS1hcGIKZGVzY3JpcHRpb246IEltcG9ydCBWaXJ0\
dWFsIE1hY2hpbmUKYmluZGFibGU6IEZhbHNlCmFzeW5jOiBvcHRpb25hbAp0YWdzOgogIC0gdmly\
dHVhbG1hY2hpbmUKbWV0YWRhdGE6CiAgZGlzcGxheU5hbWU6IEltcG9ydCBWaXJ0dWFsIE1hY2hp\
bmUKICBpbWFnZVVybDogaHR0cHM6Ly9jZG4ucGJyZC5jby9pbWFnZXMvSDVHdXRkNy5wbmcKICBs\
b25nRGVzY3JpcHRpb246IHwKICAgICBJbXBvcnQgVmlydHVhbCBNYWNoaW5lIGZyb20gYW4gZXhp\
c3RpbmcgaW1hZ2Ugb3IgYSBWTXdhcmUgZW52aXJvbm1lbnQuCnBsYW5zOgogIC0gbmFtZTogdm13\
YXJlCiAgICBkZXNjcmlwdGlvbjogSW1wb3J0IGEgdmlydHVhbCBtYWNoaW5lIGZyb20gVk13YXJl\
IHZDZW50ZXIuCiAgICBmcmVlOiBUcnVlCiAgICBtZXRhZGF0YToKICAgICAgZGlzcGxheU5hbWU6\
IGMuIEltcG9ydCBmcm9tIFZNd2FyZS4KICAgIHBhcmFtZXRlcnM6CiAgICAgIC0gdGl0bGU6IE9w\
ZW5TaGlmdCBBZG1pbiBVc2VybmFtZQogICAgICAgIG5hbWU6IGFkbWluX3VzZXIKICAgICAgICB0\
eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAtIHRpdGxlOiBPcGVuU2hp\
ZnQgQWRtaW4gUGFzc3dvcmQKICAgICAgICBuYW1lOiBhZG1pbl9wYXNzd29yZAogICAgICAgIHR5\
cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgZGlzcGxheV90eXBlOiBw\
YXNzd29yZAogICAgICAtIHRpdGxlOiBWTXdhcmUgVVJMIHRvIEVYU2kKICAgICAgICBuYW1lOiB1\
cmwKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAtIHRp\
dGxlOiBWaXJ0dWFsIE1hY2hpbmUgTmFtZQogICAgICAgIG5hbWU6IHZtX25hbWUKICAgICAgICB0\
eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgIHBhdHRlcm46ICJeW2Et\
ejAtOS4tXSokIgogICAgICAtIHRpdGxlOiBWTXdhcmUgQWRtaW4gVXNlcm5hbWUKICAgICAgICBu\
YW1lOiB1c2VybmFtZQogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVl\
CiAgICAgICAgZGlzcGxheV90eXBlOiB1c2VybmFtZQogICAgICAtIHRpdGxlOiBWTXdhcmUgQWRt\
aW4gUGFzc3dvcmQKICAgICAgICBuYW1lOiBwYXNzd29yZAogICAgICAgIHR5cGU6IHN0cmluZwog\
ICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgZGlzcGxheV90eXBlOiBwYXNzd29yZAogICAg\
ICAtIHRpdGxlOiBPcGVyYXRpbmcgU3lzdGVtIFR5cGUKICAgICAgICBuYW1lOiBvc190eXBlCiAg\
ICAgICAgZGVmYXVsdDogbGludXgKICAgICAgICBlbnVtOiBbJ2xpbnV4JywgJ3dpbmRvd3MnXQog\
ICAgICAgIHR5cGU6IGVudW0KICAtIG5hbWU6IHZtd2FyZS10ZW1wbGF0ZQogICAgZGVzY3JpcHRp\
b246IEltcG9ydCBhIHZpcnR1YWwgbWFjaGluZSBhcyBhIHRlbXBsYXRlIGZyb20gVk13YXJlIHZD\
ZW50ZXIuCiAgICBmcmVlOiBUcnVlCiAgICBtZXRhZGF0YToKICAgICAgZGlzcGxheU5hbWU6IGQu\
IEltcG9ydCBhcyBhIHRlbXBsYXRlIGZyb20gVk13YXJlLgogICAgcGFyYW1ldGVyczoKICAgICAg\
LSB0aXRsZTogT3BlblNoaWZ0IEFkbWluIFVzZXJuYW1lCiAgICAgICAgbmFtZTogYWRtaW5fdXNl\
cgogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgIC0gdGl0\
bGU6IE9wZW5TaGlmdCBBZG1pbiBQYXNzd29yZAogICAgICAgIG5hbWU6IGFkbWluX3Bhc3N3b3Jk\
CiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgICBkaXNw\
bGF5X3R5cGU6IHBhc3N3b3JkCiAgICAgIC0gdGl0bGU6IFZNd2FyZSBVUkwgdG8gRVhTaQogICAg\
ICAgIG5hbWU6IHVybAogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVl\
CiAgICAgIC0gdGl0bGU6IFRlbXBsYXRlIE5hbWUKICAgICAgICBuYW1lOiB2bV9uYW1lCiAgICAg\
ICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgICBwYXR0ZXJuOiAi\
XlthLXowLTkuLV0qJCIKICAgICAgLSB0aXRsZTogVk13YXJlIEFkbWluIFVzZXJuYW1lCiAgICAg\
ICAgbmFtZTogdXNlcm5hbWUKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDog\
dHJ1ZQogICAgICAgIGRpc3BsYXlfdHlwZTogdXNlcm5hbWUKICAgICAgLSB0aXRsZTogVk13YXJl\
IEFkbWluIFBhc3N3b3JkCiAgICAgICAgbmFtZTogcGFzc3dvcmQKICAgICAgICB0eXBlOiBzdHJp\
bmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgIGRpc3BsYXlfdHlwZTogcGFzc3dvcmQK\
ICAgICAgLSB0aXRsZTogT3BlcmF0aW5nIFN5c3RlbSBUeXBlCiAgICAgICAgbmFtZTogb3NfdHlw\
ZQogICAgICAgIGRlZmF1bHQ6IGxpbnV4CiAgICAgICAgZW51bTogWydsaW51eCcsICd3aW5kb3dz\
J10KICAgICAgICB0eXBlOiBlbnVtCiAgLSBuYW1lOiB1cmwKICAgIGRlc2NyaXB0aW9uOiBDcmVh\
dGUgYSB2aXJ0dWFsIG1hY2hpbmUgZnJvbSBhIGRvd25sb2FkZWQgZGlzayBpbWFnZS4KICAgIGZy\
ZWU6IFRydWUKICAgIG1ldGFkYXRhOgogICAgICBkaXNwbGF5TmFtZTogYS4gSW1wb3J0IGZyb20g\
VVJMLgogICAgcGFyYW1ldGVyczoKICAgICAgLSB0aXRsZTogRGlzayBJbWFnZSBVUkwKICAgICAg\
ICBuYW1lOiBkaXNrX2ltYWdlX3VybAogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVp\
cmVkOiB0cnVlCiAgICAgIC0gdGl0bGU6IE9wZXJhdGluZyBzeXN0ZW0gdHlwZQogICAgICAgIG5h\
bWU6IG9zX3R5cGUKICAgICAgICBkZWZhdWx0OiBsaW51eAogICAgICAgIGVudW06IFsnbGludXgn\
LCAnd2luZG93cyddCiAgICAgICAgdHlwZTogZW51bQogICAgICAtIHRpdGxlOiBWaXJ0dWFsIE1h\
Y2hpbmUgTmFtZQogICAgICAgIG5hbWU6IHZtX25hbWUKICAgICAgICB0eXBlOiBzdHJpbmcKICAg\
ICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgIHBhdHRlcm46ICJeW2EtejAtOS4tXSokIgogICAg\
ICAtIHRpdGxlOiBOdW1iZXIgb2YgQ29yZXMKICAgICAgICBuYW1lOiBucl9jb3JlcwogICAgICAg\
IHJlcXVpcmVkOiB0cnVlCiAgICAgICAgdHlwZTogaW50CiAgICAgICAgZGVmYXVsdDogMQogICAg\
ICAtIHRpdGxlOiBNZW1vcnkgKE1pQikKICAgICAgICBuYW1lOiBtZW0KICAgICAgICByZXF1aXJl\
ZDogdHJ1ZQogICAgICAgIHR5cGU6IGludAogICAgICAgIGRlZmF1bHQ6IDEwMjQKICAgICAgLSB0\
aXRsZTogRGlzayBTaXplIChHaUIpIChsZWF2ZSBhdCAwIHRvIGF1dG8gZGV0ZWN0IHNpemUpCiAg\
ICAgICAgbmFtZTogZGlza19zaXplX2diCiAgICAgICAgdHlwZTogaW50CiAgICAgICAgZGVmYXVs\
dDogMAogICAgICAtIHRpdGxlOiBTdG9yYWdlIENsYXNzIChsZWF2ZSBlbXB0eSB0byB1c2UgdGhl\
IGRlZmF1bHQgc3RvcmFnZSBjbGFzcykKICAgICAgICBuYW1lOiBzdG9yYWdlX2NsYXNzCiAgICAg\
ICAgdHlwZTogc3RyaW5nCiAgLSBuYW1lOiB1cmwtdGVtcGxhdGUKICAgIGRlc2NyaXB0aW9uOiBD\
cmVhdGUgYSB2aXJ0dWFsIG1hY2hpbmUgdGVtcGxhdGUgZnJvbSBhIGRvd25sb2FkZWQgZGlzayBp\
bWFnZS4KICAgIGZyZWU6IFRydWUKICAgIG1ldGFkYXRhOgogICAgICBkaXNwbGF5TmFtZTogYi4g\
SW1wb3J0IGFzIGEgdGVtcGxhdGUgZnJvbSBVUkwuCiAgICBwYXJhbWV0ZXJzOgogICAgICAtIHRp\
dGxlOiBPcGVuU2hpZnQgQWRtaW4gVXNlcm5hbWUKICAgICAgICBuYW1lOiBhZG1pbl91c2VyCiAg\
ICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgLSB0aXRsZTog\
T3BlblNoaWZ0IEFkbWluIFBhc3N3b3JkCiAgICAgICAgbmFtZTogYWRtaW5fcGFzc3dvcmQKICAg\
ICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAgIGRpc3BsYXlf\
dHlwZTogcGFzc3dvcmQKICAgICAgLSB0aXRsZTogRGlzayBJbWFnZSBVUkwKICAgICAgICBuYW1l\
OiBkaXNrX2ltYWdlX3VybAogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0\
cnVlCiAgICAgIC0gdGl0bGU6IE9wZXJhdGluZyBzeXN0ZW0gdHlwZQogICAgICAgIG5hbWU6IG9z\
X3R5cGUKICAgICAgICBkZWZhdWx0OiBsaW51eAogICAgICAgIGVudW06IFsnbGludXgnLCAnd2lu\
ZG93cyddCiAgICAgICAgdHlwZTogZW51bQogICAgICAtIHRpdGxlOiBUZW1wbGF0ZSBOYW1lCiAg\
ICAgICAgbmFtZTogdm1fbmFtZQogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVk\
OiB0cnVlCiAgICAgICAgcGF0dGVybjogIl5bYS16MC05Li1dKiQiCiAgICAgIC0gdGl0bGU6IE51\
bWJlciBvZiBDb3JlcwogICAgICAgIG5hbWU6IG5yX2NvcmVzCiAgICAgICAgcmVxdWlyZWQ6IHRy\
dWUKICAgICAgICB0eXBlOiBpbnQKICAgICAgICBkZWZhdWx0OiAxCiAgICAgIC0gdGl0bGU6IE1l\
bW9yeSAoTWlCKQogICAgICAgIG5hbWU6IG1lbQogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAg\
ICAgdHlwZTogaW50CiAgICAgICAgZGVmYXVsdDogMTAyNAogICAgICAtIHRpdGxlOiBEaXNrIFNp\
emUgKEdpQikgKGxlYXZlIGF0IDAgdG8gYXV0byBkZXRlY3Qgc2l6ZSkKICAgICAgICBuYW1lOiBk\
aXNrX3NpemVfZ2IKICAgICAgICB0eXBlOiBpbnQKICAgICAgICBkZWZhdWx0OiAwCiAgICAgIC0g\
dGl0bGU6IFN0b3JhZ2UgQ2xhc3MgKGxlYXZlIGVtcHR5IHRvIHVzZSB0aGUgZGVmYXVsdCBzdG9y\
YWdlIGNsYXNzKQogICAgICAgIG5hbWU6IHN0b3JhZ2VfY2xhc3MKICAgICAgICB0eXBlOiBzdHJp\
bmcK"



RUN chmod -R g=u /opt/{ansible,apb}
RUN yum -y install libvirt-client curl qemu-img wget && yum clean all
# We need this to get oc v3.9 due to the issue with oc apply. Once we would update apb-base to use 3.9 we can remove it
RUN wget https://github.com/openshift/origin/releases/download/v3.9.0/openshift-origin-client-tools-v3.9.0-191fece-linux-64bit.tar.gz
RUN tar zxvf openshift-origin-client-tools-v3.9.0-191fece-linux-64bit.tar.gz
RUN mv openshift-origin-client-tools-v3.9.0-191fece-linux-64bit/oc /usr/bin
RUN rm -rf openshift-origin-client-tools-v3.9.0-191fece-linux-64bit
RUN chmod u+x /usr/bin/oc
# future removal ends here
COPY bin/run-v2v.sh /v2v.d/
RUN setfacl -Rm u:apb:rwx /v2v.d

COPY playbooks /opt/apb/actions
COPY roles /opt/apb/actions/roles
COPY templates /opt/apb/actions/templates

USER apb
