FROM balenalib/armv7hf-debian

RUN [ "cross-build-start" ]

LABEL maintainer "scatat"

RUN echo "deb http://debian.opennms.org/ stable main" >> /etc/apt/sources.list \
  && apt-get update \
  && apt-get install wget \
  && wget -O - http://debian.opennms.org/OPENNMS-GPG-KEY | sudo apt-key add - \
  && echo debconf shared/accepted-oracle-license-v1-1 select true | sudo /usr/bin/debconf-set-selections \
  && echo debconf shared/accepted-oracle-license-v1-1 seen true | sudo /usr/bin/debconf-set-selections 


RUN   DEBIAN_FRONTEND=noninteractive apt-get install -y --allow-unauthenticated \
      oracle-java8-installer \
      imagemagick \
      lsof \
      nano \
      sudo \
      vim \
      jq \
      mysql-client \
      python \
    && apt-get clean

RUN useradd -s /bin/false --uid 1000 minecraft \
  && mkdir -m 777 /data /mods /config /plugins /home/minecraft \
  && chown minecraft:minecraft /data /config /mods /plugins /home/minecraft

EXPOSE 25565 25575

ARG RESTIFY_VER=1.1.6
ARG RCON_CLI_VER=1.4.6
ARG MC_SERVER_RUNNER_VER=1.3.2
ARG ARCH=armv7

ADD https://github.com/itzg/restify/releases/download/${RESTIFY_VER}/restify_${RESTIFY_VER}_linux_${ARCH}.tar.gz /tmp/restify.tgz
RUN tar -x -C /usr/local/bin -f /tmp/restify.tgz restify && \
  rm /tmp/restify.tgz

ADD https://github.com/itzg/rcon-cli/releases/download/${RCON_CLI_VER}/rcon-cli_${RCON_CLI_VER}_linux_${ARCH}.tar.gz /tmp/rcon-cli.tgz
RUN tar -x -C /usr/local/bin -f /tmp/rcon-cli.tgz rcon-cli && \
  rm /tmp/rcon-cli.tgz

ADD https://github.com/itzg/mc-server-runner/releases/download/${MC_SERVER_RUNNER_VER}/mc-server-runner_${MC_SERVER_RUNNER_VER}_linux_${ARCH}.tar.gz /tmp/mc-server-runner.tgz
RUN tar -x -C /usr/local/bin -f /tmp/mc-server-runner.tgz mc-server-runner && \
  rm /tmp/mc-server-runner.tgz

COPY mcadmin.jq /usr/share
RUN chmod +x /usr/local/bin/*

RUN [ "cross-build-end" ]

VOLUME ["/data","/mods","/config","/plugins"]
COPY server.properties /tmp/server.properties
WORKDIR /data

ENTRYPOINT [ "/start" ]

ENV JVM_XX_OPTS="-XX:+UseG1GC" MEMORY="512M" \
    TYPE=VANILLA VERSION=LATEST FORGEVERSION=RECOMMENDED SPONGEBRANCH=STABLE SPONGEVERSION= LEVEL=world \
    PVP=true DIFFICULTY=easy ENABLE_RCON=true RCON_PORT=25575 RCON_PASSWORD=minecraft \
    LEVEL_TYPE=DEFAULT GENERATOR_SETTINGS= WORLD= MODPACK= SERVER_PORT=25565 ONLINE_MODE=TRUE CONSOLE=true

COPY start* /

USER minecraft
